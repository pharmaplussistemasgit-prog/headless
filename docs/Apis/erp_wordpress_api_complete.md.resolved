# üìò Documentaci√≥n Completa: API ERP ‚Üî WordPress PharmaPlus

## üéØ Visi√≥n General

Este documento consolida **toda la arquitectura de integraci√≥n** entre el **ERP de PharmaPlus** y **WordPress/WooCommerce**. La API permite sincronizaci√≥n bidireccional de productos, √≥rdenes, clientes, y datos de negocio (descuentos B2B, convenios, laboratorios, etc.).

### üìÇ Fuentes de Documentaci√≥n
- [Base B2B/B2C](file:///F:/CLIENTES/PHARMAPLUS/pharma-headless-1a%20Vercel/docs/Apis/Api%20PharmaPlus%20V2%20-%20Base%20B2B%20B2C.csv) ‚Üí Tablas de descuentos, convenios, laboratorios
- [Orders](file:///F:/CLIENTES/PHARMAPLUS/pharma-headless-1a%20Vercel/docs/Apis/Api%20PharmaPlus%20V2%20-%20Orders.csv) ‚Üí Gesti√≥n de √≥rdenes
- [PostBatch](file:///F:/CLIENTES/PHARMAPLUS/pharma-headless-1a%20Vercel/docs/Apis/Api%20PharmaPlus%20V2%20-%20PostBatch%20Actualizado.csv) ‚Üí Sincronizaci√≥n masiva de productos
- [Productos](file:///F:/CLIENTES/PHARMAPLUS/pharma-headless-1a%20Vercel/docs/Apis/Api%20PharmaPlus%20V2%20-%20Productos.csv) ‚Üí CRUD de productos

---

## üèóÔ∏è Arquitectura General

```mermaid
graph LR
    A[ERP PharmaPlus] -->|REST API| B[WordPress/WooCommerce]
    B -->|Custom API v1| C[Headless Frontend]
    A -->|Sincronizaci√≥n Batch| B
    B -->|Webhooks| A
    
    style A fill:#e1f5ff
    style B fill:#fff3e0
    style C fill:#f3e5f5
```

### üîë Autenticaci√≥n
- **M√©todo:** API Key en header `X-API-KEY`
- **Ejemplo:** `X-API-KEY: rwYK B0nN kHbq ujB3 XRbZ slCt`
- **Base URL:** `https://tienda.pharmaplus.com.co/wp-json/custom-api/v1`

---

## üì¶ 1. API de Productos

> **Fuente:** [Api PharmaPlus V2 - Productos.csv](file:///F:/CLIENTES/PHARMAPLUS/pharma-headless-1a%20Vercel/docs/Apis/Api%20PharmaPlus%20V2%20-%20Productos.csv)

### üîÑ Versiones Disponibles

#### **API V1** (Basada en ID de WordPress)
```
POST   /wp-json/custom-api/v1/product
GET    /wp-json/custom-api/v1/products
GET    /wp-json/custom-api/v1/product/{id}
PUT    /wp-json/custom-api/v1/product/id/{id}
DELETE /wp-json/custom-api/v1/product/{id}
```

#### **API V2** (Basada en SKU - Recomendada) ‚≠ê
```
POST   /wp-json/custom-api/v1/product
POST   /wp-json/custom-api/v1/products/batch
GET    /wp-json/custom-api/v1/products
GET    /wp-json/custom-api/v1/product/sku/{sku}
PUT    /wp-json/custom-api/v1/product/sku/{sku}
PUT    /wp-json/custom-api/v1/products/sku/batch
DELETE /wp-json/custom-api/v1/product/sku/{sku}
DELETE /wp-json/custom-api/v1/products/batch/delete
```

### üìù Estructura de Producto

```json
{
  "sku": "SKU-123",
  "title": "Amoxicilina 500mg - 21 C√°psulas",
  "regular_price": "15000",
  "sale_price": "12000",
  "description": "Descripci√≥n larga del producto",
  "short_description": "Descripci√≥n corta",
  "status": "publish",
  "stock_quantity": 100,
  "stock_status": "instock",
  "manage_stock": true,
  "backorders": "no",
  "featured": true,
  "image": "https://url-imagen-principal.jpg",
  "gallery": [
    "https://url-imagen-1.jpg",
    "https://url-imagen-2.jpg"
  ],
  "categories": ["antibioticos", "medicamentos-de-receta"],
  "tags": ["infecciones", "antibiotico"],
  "upsell_skus": ["SKU-456", "SKU-789"],
  "crosssell_skus": ["SKU-111"],
  "meta": {
    "_marca": "MK",
    "_registro_invima": "122212",
    "_tipo_de_producto": "Medicamento",
    "_needs_rx": "true"
  },
  "jet_taxonomies": {
    "laboratorios": ["101"],
    "principio-activo": ["amoxicilina"],
    "departamentosciudades": ["91"]
  }
}
```

### üéØ Casos de Uso Comunes

#### 1Ô∏è‚É£ Crear Producto Individual
```bash
POST /wp-json/custom-api/v1/product
Content-Type: application/json
X-API-KEY: rwYK B0nN kHbq ujB3 XRbZ slCt

{
  "sku": "PARA500-20TAB",
  "title": "Paracetamol 500mg - 20 Tabletas",
  "regular_price": "5000",
  "stock_quantity": 200,
  "status": "publish"
}
```

#### 2Ô∏è‚É£ Sincronizaci√≥n Masiva (Batch)
> **Fuente:** [PostBatch Actualizado.csv](file:///F:/CLIENTES/PHARMAPLUS/pharma-headless-1a%20Vercel/docs/Apis/Api%20PharmaPlus%20V2%20-%20PostBatch%20Actualizado.csv)

```bash
POST /wp-json/custom-api/v1/products/batch
Content-Type: application/json

{
  "mode": "create_only",  // "create_only" | "upsert"
  "products": [
    { "sku": "SKU-1001", "title": "Producto 1", ... },
    { "sku": "SKU-1002", "title": "Producto 2", ... }
  ]
}
```

#### 3Ô∏è‚É£ Actualizar Stock por SKU
```bash
PUT /wp-json/custom-api/v1/product/sku/PARA500-20TAB

{
  "stock_quantity": 150,
  "stock_status": "instock"
}
```

#### 4Ô∏è‚É£ B√∫squeda con Filtros
```bash
GET /wp-json/custom-api/v1/products?category=antibioticos&status=publish&per_page=10
GET /wp-json/custom-api/v1/products?search=XEROLAN
GET /wp-json/custom-api/v1/products?per_page=10&page=3
```

#### 5Ô∏è‚É£ Eliminar Productos en Lote
```bash
POST /wp-json/custom-api/v1/products/batch/delete

{
  "ids": [456, 789],
  "skus": ["SKU-123", "SKU-456"]
}
```

---

## üõí 2. API de √ìrdenes

> **Fuente:** [Api PharmaPlus V2 - Orders.csv](file:///F:/CLIENTES/PHARMAPLUS/pharma-headless-1a%20Vercel/docs/Apis/Api%20PharmaPlus%20V2%20-%20Orders.csv)

### üîß Endpoints Disponibles

```
POST   /custom-api/v1/orders              ‚Üí Crear orden individual
POST   /custom-api/v1/orders/batch        ‚Üí Crear m√∫ltiples √≥rdenes
GET    /custom-api/v1/order/{id}          ‚Üí Obtener orden por ID
GET    /custom-api/v1/orders              ‚Üí Listar √≥rdenes (con filtros)
PUT    /custom-api/v1/order/{id}          ‚Üí Actualizar orden
PUT    /custom-api/v1/orders/batch        ‚Üí Actualizar m√∫ltiples √≥rdenes
DELETE /custom-api/v1/order/{id}          ‚Üí Eliminar orden
POST   /custom-api/v1/orders/batch/delete ‚Üí Eliminar m√∫ltiples √≥rdenes
```

### üìä Filtros Disponibles

| Par√°metro | Descripci√≥n | Ejemplo |
|-----------|-------------|---------|
| `page` | N√∫mero de p√°gina | `?page=1` |
| `per_page` | Resultados por p√°gina | `?per_page=10` |
| `status` | Estado de orden | `?status=processing` |
| `customer_id` | ID de usuario | `?customer_id=123` |
| `customer_email` | Email de usuario | `?customer_email=user@example.com` |
| [search](file:///f:/CLIENTES/PHARMAPLUS/pharma-headless-1a%20Vercel/app/actions/products.ts#128-177) | B√∫squeda general | `?search=chrismgarrido` |
| `orderby` | Ordenar por | `?orderby=date` |
| `order` | Direcci√≥n | `?order=DESC` |

### üè∑Ô∏è Estados de Orden

```
pending      ‚Üí Pendiente
processing   ‚Üí Procesando
on-hold      ‚Üí En espera
completed    ‚Üí Completada
cancelled    ‚Üí Cancelada
refunded     ‚Üí Reembolsada
failed       ‚Üí Fallida
```

### üìù Estructura de Orden

```json
{
  "customer_id": 11,
  "customer_email": "cliente@example.com",
  "billing": {
    "first_name": "Christian",
    "last_name": "Martinez",
    "email": "cliente@example.com",
    "phone": "3110000000",
    "address_1": "Calle 1",
    "city": "Bogot√°",
    "country": "CO"
  },
  "shipping": {
    "first_name": "Ana",
    "last_name": "P√©rez",
    "address_1": "Calle 1",
    "city": "Bogot√°",
    "country": "CO"
  },
  "items": [
    { "sku": "4652", "quantity": 2, "price": 15000 },
    { "product_id": 8683, "quantity": 1, "price": 15000 }
  ],
  "shipping_lines": [
    { "method_id": "flat_rate", "method_title": "Env√≠o est√°ndar", "total": 8000 }
  ],
  "coupon_lines": [
    { "code": "DESC10" }
  ],
  "fee_lines": [
    { "name": "Empaque", "total": 2500 }
  ],
  "payment_method": "cod",
  "payment_method_title": "Contra entrega",
  "status": "processing",
  "set_paid": true,
  "transaction_id": "T-ABC-001",
  "meta": {
    "_fuente": "api",
    "_canal": "erp"
  }
}
```

### üéØ Casos de Uso

#### 1Ô∏è‚É£ Crear Orden desde ERP
```bash
POST /custom-api/v1/orders

{
  "customer_email": "cliente@example.com",
  "billing": { ... },
  "items": [
    { "sku": "4652", "quantity": 2, "price": 15000 }
  ],
  "status": "processing",
  "set_paid": true,
  "transaction_id": "ERP-12345"
}
```

#### 2Ô∏è‚É£ Actualizar Estado de Orden
```bash
PUT /custom-api/v1/order/987

{
  "status": "completed",
  "set_paid": true,
  "transaction_id": "T-XYZ-999"
}
```

#### 3Ô∏è‚É£ Listar √ìrdenes Procesando
```bash
GET /custom-api/v1/orders?page=1&per_page=10&status=processing
```

#### 4Ô∏è‚É£ Batch: Crear M√∫ltiples √ìrdenes
```bash
POST /custom-api/v1/orders/batch

{
  "orders": [
    { "customer_email": "cliente1@example.com", ... },
    { "customer_email": "cliente2@example.com", ... }
  ]
}
```

---

## üíº 3. API de Tablas de Negocio (B2B/B2C)

> **Fuente:** [Api PharmaPlus V2 - Base B2B B2C.csv](file:///F:/CLIENTES/PHARMAPLUS/pharma-headless-1a%20Vercel/docs/Apis/Api%20PharmaPlus%20V2%20-%20Base%20B2B%20B2C.csv)

### üìã Tablas Disponibles

#### 1Ô∏è‚É£ **cliente-descuento-item** (B2B)
Descuentos personalizados por cliente y producto.

```
GET    /wp-json/custom-api/v1/cliente-descuento-item
GET    /wp-json/custom-api/v1/cliente-descuento-item/{id}
POST   /wp-json/custom-api/v1/cliente-descuento-item
PUT    /wp-json/custom-api/v1/cliente-descuento-item/{id}
DELETE /wp-json/custom-api/v1/cliente-descuento-item/{id}
```

**Estructura:**
```json
{
  "CLIENTE_ID": 1001,
  "CONVENIO_ID": 2,
  "COSTO_TIPO_ID": 1,
  "PORCENTAJE_COM": 5.25,
  "ITEM_ID": 8755,
  "VALOR": 15000,
  "FECHA_INICIAL": "2025-07-21",
  "FECHA_FINAL": "2025-08-21"
}
```

#### 2Ô∏è‚É£ **convenio** (B2B)
Convenios empresariales.

```
GET    /wp-json/custom-api/v1/convenio
GET    /wp-json/custom-api/v1/convenio/{id}
POST   /wp-json/custom-api/v1/convenio
PUT    /wp-json/custom-api/v1/convenio/{id}
DELETE /wp-json/custom-api/v1/convenio/{id}
```

#### 3Ô∏è‚É£ **costo-tipo** (B2B)
Tipos de costo para clientes corporativos.

```
GET    /wp-json/custom-api/v1/costo-tipo
GET    /wp-json/custom-api/v1/costo-tipo/{id}
POST   /wp-json/custom-api/v1/costo-tipo
PUT    /wp-json/custom-api/v1/costo-tipo/{id}
DELETE /wp-json/custom-api/v1/costo-tipo/{id}
```

#### 4Ô∏è‚É£ **descuento-call** (B2C)
Descuentos para clientes finales (call center).

```
GET    /wp-json/custom-api/v1/descuento-call
GET    /wp-json/custom-api/v1/descuento-call/{id}
POST   /wp-json/custom-api/v1/descuento-call
PUT    /wp-json/custom-api/v1/descuento-call/{id}
DELETE /wp-json/custom-api/v1/descuento-call/{id}
```

#### 5Ô∏è‚É£ **laboratorio**
Cat√°logo de laboratorios farmac√©uticos.

```
GET    /wp-json/custom-api/v1/laboratorio
GET    /wp-json/custom-api/v1/laboratorio/{id}
POST   /wp-json/custom-api/v1/laboratorio
PUT    /wp-json/custom-api/v1/laboratorio/{id}
DELETE /wp-json/custom-api/v1/laboratorio/{id}
```

#### 6Ô∏è‚É£ **precio-distrib** (B2B)
Precios especiales para distribuidores.

```
GET    /wp-json/custom-api/v1/precio-distrib
GET    /wp-json/custom-api/v1/precio-distrib/{id}
POST   /wp-json/custom-api/v1/precio-distrib
PUT    /wp-json/custom-api/v1/precio-distrib/{id}
DELETE /wp-json/custom-api/v1/precio-distrib/{id}
```

---

## üîç 4. Tabla Faltante: `item_ptc` (Promociones)

### ‚ö†Ô∏è Diagn√≥stico
- **Estado:** ‚ùå **NO EXISTE** en la API actual
- **Ubicaci√≥n Esperada:** `/wp-json/custom-api/v1/item-ptc`
- **Problema:** No est√° registrada en `$cmu_tables` del snippet CUSTOM_API

### üìä Estructura Esperada (Basada en Snippet #21)
```json
{
  "ITEM_ID": "4652",              // SKU del producto base
  "ITEM_ID_RECAMBIO": "68146",    // SKU del producto regalo
  "POR_COMPRA_DE": 2,             // Cantidad m√≠nima a comprar
  "RECIBE_PTC": 1,                // Cantidad de regalo
  "FECHA_INICIO": "2025-01-01",   // Fecha inicio promoci√≥n
  "FECHA_FIN": "2025-12-31"       // Fecha fin promoci√≥n
}
```

### ‚úÖ Soluci√≥n Propuesta
Ver [Punto 19 del Plan de Desarrollo](file:///f:/CLIENTES/PHARMAPLUS/pharma-headless-1a%20Vercel/docs/plan_desarrollo_31_puntos.md#L190-L292) para implementaci√≥n completa.

---

## üîê 5. Seguridad y Mejores Pr√°cticas

### üõ°Ô∏è Autenticaci√≥n
```javascript
const headers = {
  'Content-Type': 'application/json',
  'X-API-KEY': process.env.WORDPRESS_API_KEY
};
```

### ‚ö° Rate Limiting
- **Recomendaci√≥n:** M√°ximo 60 requests/minuto
- **Batch Operations:** Preferir siempre sobre m√∫ltiples requests individuales

### üîÑ Sincronizaci√≥n Eficiente

#### ‚úÖ **CORRECTO:** Batch Update
```javascript
// Actualizar 100 productos en 1 request
await fetch('/wp-json/custom-api/v1/products/batch', {
  method: 'POST',
  body: JSON.stringify({
    mode: 'upsert',
    products: [...100 productos]
  })
});
```

#### ‚ùå **INCORRECTO:** Requests Individuales
```javascript
// 100 requests separados (lento y sobrecarga el servidor)
for (const product of products) {
  await fetch(`/wp-json/custom-api/v1/product/sku/${product.sku}`, {
    method: 'PUT',
    body: JSON.stringify(product)
  });
}
```

---

## üìö 6. Resumen de Endpoints por Categor√≠a

### üõçÔ∏è Productos
| Operaci√≥n | Endpoint | M√©todo |
|-----------|----------|--------|
| Crear individual | `/product` | POST |
| Crear batch | `/products/batch` | POST |
| Listar | `/products` | GET |
| Obtener por SKU | `/product/sku/{sku}` | GET |
| Actualizar por SKU | `/product/sku/{sku}` | PUT |
| Actualizar batch | `/products/sku/batch` | PUT |
| Eliminar por SKU | `/product/sku/{sku}` | DELETE |
| Eliminar batch | `/products/batch/delete` | POST |

### üì¶ √ìrdenes
| Operaci√≥n | Endpoint | M√©todo |
|-----------|----------|--------|
| Crear individual | `/orders` | POST |
| Crear batch | `/orders/batch` | POST |
| Listar | `/orders` | GET |
| Obtener por ID | `/order/{id}` | GET |
| Actualizar | `/order/{id}` | PUT |
| Actualizar batch | `/orders/batch` | PUT |
| Eliminar | `/order/{id}` | DELETE |
| Eliminar batch | `/orders/batch/delete` | POST |

### üíº Tablas de Negocio
| Tabla | Endpoint Base | Tipo |
|-------|---------------|------|
| Cliente Descuento | `/cliente-descuento-item` | B2B |
| Convenio | `/convenio` | B2B |
| Costo Tipo | `/costo-tipo` | B2B |
| Descuento Call | `/descuento-call` | B2C |
| Laboratorio | `/laboratorio` | General |
| Precio Distribuidor | `/precio-distrib` | B2B |
| **Item PTC** | `/item-ptc` | **üî¥ PENDIENTE** |

---

## üéì 7. Ejemplos de Integraci√≥n

### Node.js / Next.js
```typescript
// services/wordpress-api.ts
const API_BASE = 'https://tienda.pharmaplus.com.co/wp-json/custom-api/v1';
const API_KEY = process.env.WORDPRESS_API_KEY;

export async function syncProductsFromERP(products: Product[]) {
  const response = await fetch(`${API_BASE}/products/batch`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-API-KEY': API_KEY
    },
    body: JSON.stringify({
      mode: 'upsert',
      products
    })
  });
  
  return response.json();
}

export async function getOrdersByStatus(status: string) {
  const response = await fetch(
    `${API_BASE}/orders?status=${status}&per_page=50`,
    {
      headers: { 'X-API-KEY': API_KEY }
    }
  );
  
  return response.json();
}
```

### Python (ERP Integration)
```python
import requests

API_BASE = "https://tienda.pharmaplus.com.co/wp-json/custom-api/v1"
API_KEY = "rwYK B0nN kHbq ujB3 XRbZ slCt"

def sync_products(products):
    response = requests.post(
        f"{API_BASE}/products/batch",
        headers={
            "Content-Type": "application/json",
            "X-API-KEY": API_KEY
        },
        json={
            "mode": "upsert",
            "products": products
        }
    )
    return response.json()

def update_order_status(order_id, status):
    response = requests.put(
        f"{API_BASE}/order/{order_id}",
        headers={"X-API-KEY": API_KEY},
        json={"status": status}
    )
    return response.json()
```

---

## üìñ Referencias Cruzadas

### Documentos Relacionados
- [CUSTOM_API_V3.3.md](file:///f:/CLIENTES/PHARMAPLUS/pharma-headless-1a%20Vercel/docs/snippets/CUSTOM_API_V3.3.md) ‚Üí Implementaci√≥n completa del snippet
- [Snippet #21: Beneficios B2C](file:///f:/CLIENTES/PHARMAPLUS/pharma-headless-1a%20Vercel/docs/snippets/woocommerce_beneficios_b2c.php) ‚Üí L√≥gica de promociones PTC
- [Plan de Desarrollo 31 Puntos](file:///f:/CLIENTES/PHARMAPLUS/pharma-headless-1a%20Vercel/docs/plan_desarrollo_31_puntos.md) ‚Üí Estado de implementaci√≥n

### Archivos Fuente CSV
1. [Base B2B B2C](file:///F:/CLIENTES/PHARMAPLUS/pharma-headless-1a%20Vercel/docs/Apis/Api%20PharmaPlus%20V2%20-%20Base%20B2B%20B2C.csv)
2. [Orders](file:///F:/CLIENTES/PHARMAPLUS/pharma-headless-1a%20Vercel/docs/Apis/Api%20PharmaPlus%20V2%20-%20Orders.csv)
3. [PostBatch Actualizado](file:///F:/CLIENTES/PHARMAPLUS/pharma-headless-1a%20Vercel/docs/Apis/Api%20PharmaPlus%20V2%20-%20PostBatch%20Actualizado.csv)
4. [Productos](file:///F:/CLIENTES/PHARMAPLUS/pharma-headless-1a%20Vercel/docs/Apis/Api%20PharmaPlus%20V2%20-%20Productos.csv)

---

## ‚úÖ Checklist de Implementaci√≥n

### Frontend (Headless)
- [x] Consumir API de productos ([lib/woocommerce.ts](file:///f:/CLIENTES/PHARMAPLUS/pharma-headless-1a%20Vercel/lib/woocommerce.ts))
- [x] Filtrado por stock (`stockStatus: 'instock'`)
- [x] B√∫squeda de productos (incluyendo agotados)
- [ ] Integrar API de promociones PTC (pendiente endpoint)
- [ ] Mostrar descuentos B2B seg√∫n usuario logueado

### Backend (WordPress)
- [x] CUSTOM_API_V3.3 desplegado
- [x] Endpoints de productos funcionando
- [x] Endpoints de √≥rdenes funcionando
- [x] Tablas B2B/B2C registradas
- [ ] **Agregar tabla `item_ptc` a CUSTOM_API**
- [ ] Webhooks para notificar ERP de nuevas √≥rdenes

### ERP
- [ ] Sincronizaci√≥n autom√°tica de inventario (batch)
- [ ] Actualizaci√≥n de precios en tiempo real
- [ ] Creaci√≥n de √≥rdenes desde WordPress
- [ ] Gesti√≥n de promociones PTC

---

**√öltima Actualizaci√≥n:** 2026-02-06  
**Versi√≥n API:** V2 (SKU-based)  
**Estado:** ‚úÖ Documentaci√≥n Completa
